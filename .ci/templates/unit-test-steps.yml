# Unit Test steps
steps:

- bash: |
    echo "##vso[task.prependpath]/data/anaconda/bin"
  displayName: Add Conda to PATH

- bash: |
    conda env create -f classification/environment.yml
    source activate cvbp
    conda env list  
  displayName: 'Create and activate conda environment'

- bash: |
    source activate cvbp
    python -m ipykernel install --user --name cvbp --display-name "cvbp"
    pytest tests/unit --junitxml=junit/test-unitttest.xml --cov=classification --cov-report=xml --cov-report=html
  displayName: 'Run Unit tests'

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: Cobertura
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
    reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'

- bash: |
      echo Remove Conda Environment
      conda remove -n cvbp --all -q --force -y
      conda env list
      echo Done Cleanup
  displayName: 'Cleanup Task'
  condition: always()

- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/test-unitttest.xml'
    testRunTitle: 'Test results for PyTest'
